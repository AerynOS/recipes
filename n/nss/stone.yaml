#
# SPDX-FileCopyrightText: Â© 2020-2024 Serpent OS Developers
#
# SPDX-License-Identifier: MPL-2.0
#
name        : nss
version     : "3.113"
release     : 29
summary     : Network Security Services
license     : MPL-2.0
homepage    : https://wiki.mozilla.org/NSS
description : |
    Network Security Services (NSS) is a set of libraries designed to support cross-platform development of security-enabled client and server applications.
upstreams   :
    - https://ftp.mozilla.org/pub/security/nss/releases/NSS_3_113_RTM/src/nss-3.113.tar.gz : acef06b512d3bd81c87a63b3c8653d258bb689d2191fc0e64decf5a1efa01c0f
builddeps   :
    - binary(openssl)
    - binary(perl)
    - binary(python3)
    - pkgconfig(nspr)
    - pkgconfig(sqlite3)
    - pkgconfig(zlib)
setup       : |
    %patch %(pkgdir)/nss-3.97-standalone-1.patch
    %patch %(pkgdir)/respect-ldflags.patch
    %patch %(pkgdir)/clang-assembler.patch

    cd nss
    mkdir -p certs
    ln -srft certs lib/ckfw/builtins/{certdata.txt,nssckbi.h}
build       : |
    cd nss
    %make BUILT_OPT=1 \
          NSPR_INCLUDE_DIR=%(includedir)/nspr \
          NSS_DISABLE_GTESTS=1 \
          NSS_ENABLE_WERROR=0 \
          NSS_USE_SYSTEM_SQLITE=1 \
          USE_64=1 \
          USE_SYSTEM_ZLIB=1 \
          NATIVE_CC="${CC}" \
          AR="${AR} rc \$@" \
          NATIVE_FLAGS="${CFLAGS}" \
          NATIVE_LDFLAGS="${LDFLAGS}"

    # Build ca-certificates-mozilla
    pushd certs
    %(pkgdir)/certdata2pem.py
    popd
    %(pkgdir)/bundle.sh
install     : |
    # NSS
    %install_dir %(installroot)%(libdir)
    %install_exe dist/Linux*/lib/*.so %(installroot)%(libdir)/.
    %install_dir %(installroot)%(includedir)/nss
    for f in dist/public/nss/*.h dist/private/nss/*.h; do
        %install_file $f %(installroot)%(includedir)/nss/.
    done
    for i in certutil nss-config pk12util; do
        %install_file dist/Linux*/bin/${i} %(installroot)%(bindir)/${i}
    done
    %install_file dist/Linux*/lib/pkgconfig/nss.pc %(installroot)%(libdir)/pkgconfig/nss.pc

    # ca-certificates-mozilla
    %install_file nss/ca-bundle.trust.p11-kit %(installroot)%(datadir)/ca-certificates/trust-source/mozilla.trust.p11-kit
packages    :
    - "%(name)":
        paths:
            - /usr/lib/*.so

    - "%(name)-devel":
        paths:
            - /usr/bin/nss-config

    - "ca-certificates-mozilla":
        summary: Mozilla's set of trusted CA certificates
        description: Mozilla's set of trusted CA certificates
        rundeps:
            - binary(update-ca-trust)
        paths:
            - /usr/share/ca-certificates
