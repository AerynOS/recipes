From baa9319b9ead18eb5586b5e32c2fb31751d79cb0 Mon Sep 17 00:00:00 2001
From: midipix <writeonce@midipix.org>
Date: Jul 09 2025 00:13:45 +0000
Subject: slbt_ar_get_archive_meta(): properly handle llvm-ar's long-name deduplication.


---

diff --git a/src/arbits/slbt_archive_meta.c b/src/arbits/slbt_archive_meta.c
index 499bfaf..fba7f6d 100644
--- a/src/arbits/slbt_archive_meta.c
+++ b/src/arbits/slbt_archive_meta.c
@@ -326,6 +326,7 @@ int slbt_ar_get_archive_meta(
 	const char *                    slash;
 	const char *                    ch;
 	const char *                    fldcap;
+	const char *                    namemark;
 	size_t				nelements;
 	uint64_t                        nentries;
 	uint64_t                        nmembers;
@@ -454,7 +455,8 @@ int slbt_ar_get_archive_meta(
 			stblsize++;
 			stblsize++;
 
-			stblsize += namelen;
+			namemark  = &arhdr->ar_file_id[0];
+			namemark += sizeof(struct ar_raw_file_header);
 
 			arlongnames = arhdr;
 
@@ -487,6 +489,13 @@ int slbt_ar_get_archive_meta(
 				stblsize++;
 			} else {
 				attr = AR_HEADER_ATTR_NAME_REF | AR_HEADER_ATTR_SYSV;
+
+				ch = &namemark[nameoff];
+
+				for (; *ch && (*ch != '/') && (*ch != AR_OBJ_PADDING); )
+					ch++;
+
+				stblsize += (ch - &namemark[nameoff]) + 1;
 			}
 
 		/* bsd long name reference? */

