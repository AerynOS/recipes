#
# SPDX-FileCopyrightText: Â© 2020-2024 Serpent OS Developers
#
# SPDX-License-Identifier: MPL-2.0
#
name        : systemd
version     : '252.22'
release     : 10
summary     : A System and Service Manager
license     :
    - GPL-2.0-or-later
    - LGPL-2.1-or-later
    - MIT
homepage    : http://www.freedesktop.org/wiki/Software/systemd
description : |
    A System and Service Manager
upstreams   :
    - https://github.com/systemd/systemd-stable/archive/v252.22.tar.gz: a01a6a483858701cb7b6c727132efa1173f63d4306602653baa0c7080bc861a8
builddeps   :
    - acl-devel
    - attr-devel
    - binary(gperf)
    - binary(m4)
    - binary(xsltproc)
    - docbook
    - gettext-devel
    - gnu-efi-devel
    - pkgconfig(blkid)
    - pkgconfig(bzip2)
    - pkgconfig(dbus-1)
    - pkgconfig(fdisk)
    - pkgconfig(glib-2.0)
    - pkgconfig(gnutls)
    - pkgconfig(gpg-error)
    - pkgconfig(libacl)
    - pkgconfig(libcap)
    - pkgconfig(libcryptsetup)
    - pkgconfig(libcurl)
    - pkgconfig(libdw)
    - pkgconfig(libffi)
    - pkgconfig(libgcrypt)
    - pkgconfig(libidn2)
    - pkgconfig(libkmod)
    - pkgconfig(liblz4)
    - pkgconfig(liblzma)
    - pkgconfig(libpcre2-8)
    - pkgconfig(libseccomp)
    - pkgconfig(libxcrypt)
    - pkgconfig(libzstd)
    - pkgconfig(mount)
    - pkgconfig(openssl)
    - pkgconfig(pam)
    - pkgconfig(polkit-gobject-1)
    - pkgconfig(pwquality)
    - pkgconfig(pwquality)
    - pkgconfig(tss2-esys)
    - pkgconfig(xkbcommon)
    - pkgconfig(zlib)
    - python-jinja
toolchain   : gnu
setup       : |
    %patch %(pkgdir)/0001-Set-DefaultTimeoutStopSec-to-5s.patch
    %patch %(pkgdir)/0016-tmpfiles-Make-var-cache-ldconfig-world-readable.patch
    %patch %(pkgdir)/systemd-245-disable-audit-by-default.patch

    %meson \
        -Dbpf-framework=false \
        -Defi=true \
        -Dfuzz-tests=false \
        -Dgnu-efi=true \
        -Dinstall-tests=false \
        -Dmode=release \
        -Dpamconfdir="%(vendordir)/etc/pam.d" \
        -Dpcre2=true \
        -Drpmmacrosdir=no \
        -Dslow-tests=false \
        -Dsplit-bin=true \
        -Dsplit-usr=false \
        -Dtests=false \
        -Drepart=true \
        -Dsysupdate=false \
        -Duserdb=true \
        -Dhomed=true \
        -Dinstall-sysconfdir=false \
        -Dnss-systemd=true \
        -Dman=true \
        -Dxdg-autostart=true \
        -Ddefault-compression=zstd \
        -Dkmod=true \
        -Dpwquality=true
build       : |
    %meson_build
install     : |
    %meson_install

    # Stateless: Clean up /var directories, they are created via tmpfiles already
    rmdir %(installroot)/var/lib/systemd %(installroot)/var/lib
    rmdir %(installroot)/var/log/journal %(installroot)/var/log %(installroot)/var

    # VERY temporary file to cause systemd-networkd to start DHCP on any enp interfaces.
    # This is a temporary fix until something like NetworkManager is put into place
    %install_file %(pkgdir)/temporary.network %(installroot)/%(libdir)/systemd/network/70-temporary.network

    # Don't clobber pam!
    rm -rf %(installroot)%(datadir)/factory/etc/pam.d