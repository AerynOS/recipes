#
# SPDX-FileCopyrightText: Â© 2026 AerynOS Developers
#
# SPDX-License-Identifier: MPL-2.0
#
name        : wpa_supplicant
version     : "2.11"
release     : 1
homepage    : https://w1.fi/wpa_supplicant
upstreams   :
    - https://w1.fi/releases/wpa_supplicant-2.11.tar.gz : 912ea06f74e30a8e36fbb68064d6cdff218d8d591db0fc5d75dee6c81ac7fc0a
summary     : A utility providing key negotiation for WPA wireless networks
description : |
    A utility providing key negotiation for WPA wireless networks
license     :
    - BSD-3-Clause
builddeps   :
    - pkgconfig(dbus-1)
    - pkgconfig(libnl-3.0)
    - pkgconfig(libpcsclite)
    - pkgconfig(openssl)
    - pkgconfig(readline)
environment : |
    export BINDIR="%(bindir)"
    export LIBDIR="%(libdir)"
    export INCDIR="%(includedir)"
setup       : |
    # More permissive TLS fallback
    %patch %(pkgdir)/0001-Enable-TLSv1.0-by-default.patch
    # https://salsa.debian.org/debian/wpa/-/commit/13e1d28e4f987a220c546df94df86bb9b2371874
    %patch %(pkgdir)/0002-Disable-Werror-for-eapol_test.patch
    # https://lists.infradead.org/pipermail/hostap/2022-May/040511.html
    # https://bugs.archlinux.org/task/76474
    %patch %(pkgdir)/0003-Allow-legacy-renegotiation-to-fix-PEAP-issues-with-s.patch
    # Unit improvements from Ubuntu
    %patch %(pkgdir)/0004-Tweak-D-Bus-systemd-service-activation-configuration.patch
    %patch %(pkgdir)/0005-Add-IgnoreOnIsolate-yes-to-keep-wpa-supplicant-runni.patch
    # More unit improvements from Debian
    %patch %(pkgdir)/0006-Add-reload-support-to-the-systemd-unit-files.patch
    # https://lists.infradead.org/pipermail/hostap/2022-January/040178.html
    %patch %(pkgdir)/0007-nl80211-add-extra-ies-only-if-allowed-by-driver.patch
    # https://w1.fi/cgit/hostap/commit/?id=c330b5820eefa8e703dbce7278c2a62d9c69166a
    %patch %(pkgdir)/0008-Send-CTRL-EVENT-SIGNAL-CHANGE-message-to-control-interfaces-only.patch
    # nullptr crash fix
    %patch %(pkgdir)/0009-nl80211-NULL-pointer-check-for-link-before-use.patch
    %install_file %(pkgdir)/wpa_supplicant_config wpa_supplicant/.config
build       : |
    cd wpa_supplicant
    %make
    %make eapol_test
    # Needs docbook-utils
    # %make -C doc/docbook man
install     : |
    cd wpa_supplicant
    %make_install
    %install_bin eapol_test
    %install_file wpa_supplicant.conf -t %(installroot)%(docdir)/wpa_supplicant/
    %install_file dbus/fi.w1.wpa_supplicant1.service -t %(installroot)%(datadir)/dbus-1/system-services/
    %install_file dbus/dbus-wpa_supplicant.conf %(installroot)%(datadir)/dbus-1/system.d/wpa_supplicant.conf
    #%install_file doc/docbook/*.5 -t %(installroot)%(mandir)/man5
    #%install_file doc/docbook/*.8 -t %(installroot)%(mandir)/man8
    #rm %(installroot)%(mandir)/man8/wpa_{priv,gui}.8
    %install_file systemd/*.service -t %(installroot)%(libdir)/systemd/system/

    # Fix /etc and /run
    %install_file %(pkgdir)/wpa_supplicant.tmpfiles %(installroot)%(tmpfilesdir)/%(name).conf
    
    # Install NetworkManager config
    %install_file %(pkgdir)/nm_wpa_supplicant.conf %(installroot)%(libdir)/NetworkManager/conf.d/wifi_backend.conf
packages    :
    - "%(name)-nm-backend-conf":
        summary: NetworkManager backend configuration
        description: Set wpa_supplicant backend as default for NetworkManager
        rundeps:
            - binary(wpa_supplicant)
            - networkmanager-wifi
        paths:
            - /usr/lib/NetworkManager/conf.d/wifi_backend.conf
