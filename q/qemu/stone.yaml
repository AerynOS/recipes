#
# SPDX-FileCopyrightText: Â© 2020-2024 Serpent OS Developers
#
# SPDX-License-Identifier: MPL-2.0
#
name        : qemu
version     : 10.0.2
release     : 18
homepage    : http://www.qemu.org/
upstreams   :
    - https://download.qemu.org/qemu-10.0.2.tar.xz : ef786f2398cb5184600f69aef4d5d691efd44576a3cff4126d38d4c6fec87759
summary     :  A generic and open source machine emulator and virtualizer
description : |
     A generic and open source machine emulator and virtualizer
license     :
    - GPL-2.0
builddeps   :
    - binary(bzip2)
    - binary(meson)
    - binary(ninja)
    - binary(nm)
    - binary(pip)
    - binary(python3)
    - pkgconfig(SDL2_image)
    - pkgconfig(alsa)
    - pkgconfig(epoxy)
    - pkgconfig(fuse3)
    - pkgconfig(gbm)
    - pkgconfig(gio-2.0)
    - pkgconfig(glib-2.0)
    - pkgconfig(gmp)
    - pkgconfig(gtk+-3.0)
    - pkgconfig(gtk+-x11-3.0)
    - pkgconfig(libbpf)
    - pkgconfig(libcap-ng)
    - pkgconfig(libcurl)
    - pkgconfig(libdw)
    - pkgconfig(libfdt)
    - pkgconfig(libgcrypt)
    - pkgconfig(libjpeg)
    - pkgconfig(libpipewire-0.3)
    - pkgconfig(libpng)
    - pkgconfig(libpulse)
    - pkgconfig(libseccomp)
    - pkgconfig(libssh)
    - pkgconfig(libtasn1)
    - pkgconfig(libudev)
    - pkgconfig(libusb-1.0)
    - pkgconfig(libzstd)
    - pkgconfig(ncurses)
    - pkgconfig(pam)
    - pkgconfig(pixman-1)
    - pkgconfig(sdl2-compat)
    - pkgconfig(slirp)
    - pkgconfig(snappy)
    - pkgconfig(spice-protocol)
    - pkgconfig(spice-server)
    - pkgconfig(virglrenderer)
    - pkgconfig(vte-2.91)
    - pkgconfig(x11)
    - pkgconfig(xkbcommon)
    - pkgconfig(zlib)
    - python(setuptools)
setup       : |
    %configure --disable-docs \
               --target-list=x86_64-linux-user,i386-linux-user,i386-softmmu,x86_64-softmmu \
               -Db_lto=true \
               -Db_lto_mode=thin \
               -Dmodules=enabled
build       : |
    %make
install     : |
    %make_install

    %install_file %(pkgdir)/qemu-guest-agent.service -t %(installroot)/%(libdir)/systemd/system/
    %install_file %(pkgdir)/qemu-guest-agent.preset %(installroot)/%(libdir)/systemd/system-preset/99-qemu-guest-agent.preset
    %install_file %(pkgdir)/99-qemu-guest-agent.rules -t %(installroot)/%(libdir)/udev/rules.d/

    # TODO: Enable name override in %%tmpfiles macro
    mkdir -p %(installroot)%(tmpfilesdir)
    echo "d /var/log/qemu-ga 0755 root root -" >> %(installroot)%(tmpfilesdir)/qemu-guest-agent.conf

    # TODO: Stop boulder emitting dependencies for these guys
    rm -v %(installroot)%(datadir)/qemu/s390*
    rm -v %(installroot)%(datadir)/qemu/hppa*
packages    :
    - "qemu-guest-agent":
        paths:
            - /usr/bin/qemu-ga
            - /usr/lib/systemd/system/qemu-guest-agent.service
            - /usr/lib/systemd/system-preset/99-qemu-guest-agent.preset
            - /usr/lib/udev/rules.d/99-qemu-guest-agent.rules
            - /usr/lib/tmpfiles.d/qemu-guest-agent.conf
