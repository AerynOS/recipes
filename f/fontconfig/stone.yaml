#
# SPDX-FileCopyrightText: Â© 2020-2024 Serpent OS Developers
#
# SPDX-License-Identifier: MPL-2.0
#
name        : fontconfig
version     : '2.17.1'
release     : 16
homepage    : https://www.freedesktop.org/wiki/Software/fontconfig
upstreams   :
    - https://gitlab.freedesktop.org/api/v4/projects/890/packages/generic/fontconfig/2.17.1/fontconfig-2.17.1.tar.xz : 9f5cae93f4fffc1fbc05ae99cdfc708cd60dfd6612ffc0512827025c026fa541
summary     : Library for configuring and customizing font access
description : |
    Fontconfig can:
        - discover new fonts when installed automatically, removing a common source of configuration problems.
        - perform font name substitution, so that appropriate alternative fonts can be selected if fonts are missing.
        - identify the set of fonts required to completely cover a set of languages.
        - have GUI configuration tools built as it uses an XML-based configuration file (though with autodiscovery, we believe this need is minimized).
        - efficiently and quickly find the fonts you need among the set of fonts you have installed, even if you have installed thousands of fonts, while minimzing memory usage.
        - be used in concert with the X Render Extension and FreeType to implement high quality, anti-aliased and subpixel rendered text on a display.
license     : MIT
builddeps   :
    - binary(gperf)
    - binary(xgettext)
    - pkgconfig32(freetype2)
    - pkgconfig32(libxml-2.0)
    # TODO: docbook2man needed for man pages
emul32      : yes
setup       : |
    %patch %(pkgdir)/stateless/Support-user-config.patch

    %meson \
        -Dbaseconfig-dir=%(sysconfdir)/fonts \
        -Dbitmap-conf=noinstall \
        -Dconfig-dir=%(sysconfdir)/fonts/conf.d \
        -Ddefault-hinting=slight \
        -Ddefault-sub-pixel-rendering=noinstall \
        -Ddoc=disabled \
        -Dtests=disabled \
        -Dxml-backend=libxml2
build       : |
    %meson_build
install     : |
    %meson_install
    if [[ %(target_triple) = i686* ]]; then
        exit 0
    fi

    # Stateless
    mv %(installroot)%(sysconfdir)/fonts/fonts.conf %(installroot)%(datadir)/fontconfig/fonts.conf
    %install_dir %(installroot)%(datadir)/fontconfig/conf.default
    for _f in "%(installroot)"/etc/fonts/conf.d/*.conf; do
        ln -srv "%(installroot)"/usr/share/fontconfig/conf.{avail,default}/"${_f##*/}"
        rm "$_f"
    done

    # Remain compatible with expected fontconfig lookup paths, ala fontdb for cosmic
    %install_file %(pkgdir)/fonts.conf %(installroot)/usr/share/fontconfig/fonts.conf.link

    # Font triggers
    %install_file %(pkgdir)/trigger.yaml %(installroot)/usr/share/moss/triggers/sys.d/fonts-cache.yaml

    # tmpfiles configuration
    %tmpfiles "# Create font compatibility link"
    %tmpfiles "d /var/cache/fontconfig 0755 root root -"
    %tmpfiles "d= /etc/fonts/ 0755 root root -"
    %tmpfiles "d /etc/fonts/conf.d 0755 root root -"
    %tmpfiles "L+ /etc/fonts/fonts.conf - - - - /usr/share/fontconfig/fonts.conf.link"
packages    :
    - "%(name)-devel":
        paths:
            - /usr/share/gettext/
