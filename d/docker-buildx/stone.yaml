#
# SPDX-FileCopyrightText: Â© 2020-2024 Serpent OS Developers
#
# SPDX-License-Identifier: MPL-2.0
#
name        : docker-buildx
version     : 0.24.0
release     : 5
homepage    : https://github.com/docker/buildx
upstreams   :
    - https://github.com/docker/buildx/archive/refs/tags/v0.24.0.tar.gz : c20f30462818a4e9224ac8dbd639ff9da323ecf40f296095e5a693296ad4b765
summary     : Docker CLI plugin for extended build capabilities with BuildKit 
description : |
    Docker CLI plugin for extended build capabilities with BuildKit 
license     :
    - Apache-2.0
networking  : yes
builddeps   :
    - binary(go)
environment : |
    export _buildx_r=github.com/docker/buildx
    export _cli_plugins_dir=%(libdir)/docker/cli-plugins
setup       : |
    mkdir -p src/${_buildx_r}
    ln -s ${PWD} src/${_buildx_r}/buildx

    go mod vendor
build      : |
    cd src/${_buildx_r}/buildx
    export GO111MODULE=auto

    export CGO_CFLAGS="${CFLAGS}"
    export GOFLAGS="-buildmode=pie -trimpath -mod=readonly -modcacherw"

    # Git commit corresponding to the version tag
    export GITCOMMIT=$(git ls-remote https://github.com/docker/buildx refs/tags/v%(version)^{} |awk '{print $1}')

    go build -o docker-buildx \
        -ldflags "-linkmode=external \
        -X ${_buildx_r}/version.Version=v%(version) \
        -X ${_buildx_r}/version.Revision=$GITCOMMIT \
        -X ${_buildx_r}/version.Package=${_buildx_r}" \
        ./cmd/buildx
install    : |
    %install_exe docker-buildx -t %(installroot)/${_cli_plugins_dir}
