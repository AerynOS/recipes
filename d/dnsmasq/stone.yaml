#
# SPDX-FileCopyrightText: Â© 2020-2025 Serpent OS Developers
#
# SPDX-License-Identifier: MPL-2.0
#
name        : dnsmasq
version     : "2.91"
release     : 1
homepage    : https://thekelleys.org.uk/dnsmasq
upstreams   :
    - https://thekelleys.org.uk/dnsmasq/dnsmasq-2.91.tar.xz : f622682848b33677adb2b6ad08264618a2ae0a01da486a93fd8cd91186b3d153
summary     : DNS cache and forwarder
description : |
    dnsmasq is used to forward and cache DNS queries.
license     : GPL-2.0-or-later
builddeps   :
    - binary(xgettext)
    - pkgconfig(dbus-1)
    - pkgconfig(gmp)
    - pkgconfig(nettle)
setup       : |
    # Causes severe delays otherwise
    %patch %(pkgdir)/Disable-ICMP-echo-address-checking.patch

    %patch %(pkgdir)/Do-not-rebuild-when-installing.patch
    %patch %(pkgdir)/Make-it-stateless.patch

    # corresponding sysusers file installed below
    sed -e 's|#define CHUSER "nobody"|#define CHUSER "dnsmasq"|' \
        -e 's|#define CHGRP "dip"|#define CHGRP "dnsmasq"|' -i src/config.h
        
    sed -e 's|%%%%PREFIX%%%%|/usr|' -i dnsmasq.conf.example
build       : |
    %make all-i18n \
        CFLAGS="${CFLAGS}" \
        COPTS='-DHAVE_DBUS -DHAVE_DNSSEC' \
        LDFLAGS="${LDFLAGS}"
install     : |
    %make install-i18n DESTDIR=%(installroot) PREFIX=/usr BINDIR=/usr/bin

    %install_file dnsmasq.conf.example %(installroot)/%(vendordir)/%(name)/dnsmasq.conf
    %install_file trust-anchors.conf -t %(installroot)/%(datadir)/dnsmasq

    %install_file dbus/dnsmasq.conf %(installroot)/%(datadir)/dbus-1/system.d/uk.org.thekelleys.dnsmasq.conf
    %install_file %(pkgdir)/dnsmasq.service -t %(installroot)/%(libdir)/systemd/system
    %install_file %(pkgdir)/dnsmasq.sysusers %(installroot)/%(libdir)/sysusers.d/dnsmasq.conf
