From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Reilly Brogan <reilly@reillybrogan.com>
Date: Fri, 19 Jul 2024 17:27:36 -0500
Subject: [PATCH] solus: Allow for skipping firmware installation

Signed-off-by: Reilly Brogan <reilly@reillybrogan.com>
Modifyied-by: Philip Mueller <philm@manjaro.org>
---
 dracut.sh                    | 5 +++++
 man/dracut.8.adoc            | 3 +++
 src/install/dracut-install.c | 5 +++++
 3 files changed, 13 insertions(+)

diff --git a/dracut.sh b/dracut.sh
index a30ebb5c..551b2918 100755
--- a/dracut.sh
+++ b/dracut.sh
@@ -124,6 +124,7 @@ Creates initial ramdisk images for preloading modules
                          where to look for libraries.
   --kernel-only         Only install kernel drivers and firmware files.
   --no-kernel           Do not install kernel drivers and firmware files.
+  --no-firmware         If specified no firmware will be installed into the initrd
   --print-cmdline       Print the kernel command line for the given disk layout.
   --early-microcode     Combine early microcode with ramdisk.
   --no-early-microcode  Do not combine early microcode with ramdisk.
@@ -418,6 +419,7 @@ rearrange_params() {
             --long force \
             --long kernel-only \
             --long no-kernel \
+            --long no-firmware \
             --long print-cmdline \
             --long kernel-cmdline: \
             --long strip \
@@ -789,6 +791,9 @@ while :; do
             kernel_only="yes"
             no_kernel="yes"
             ;;
+        --no-firmware)
+            export DRACUT_FIRMWARE_SKIP=1
+            ;;
         --early-microcode)
             early_microcode_l="yes"
             ;;
diff --git a/man/dracut.8.adoc b/man/dracut.8.adoc
index e353a98a..8ddcd804 100644
--- a/man/dracut.8.adoc
+++ b/man/dracut.8.adoc
@@ -238,6 +238,9 @@ example:
 **--no-kernel**::
     Do not install kernel drivers and firmware files.
 
+**--no-firmware**::
+    Do not install firmware files.
+
 **--early-microcode**::
     Combine early microcode with ramdisk.
 
diff --git a/src/install/dracut-install.c b/src/install/dracut-install.c
index efa64306..b6919446 100644
--- a/src/install/dracut-install.c
+++ b/src/install/dracut-install.c
@@ -1999,6 +1999,11 @@ static int install_all(int argc, char **argv)
 
 static int install_firmware_fullpath(const char *fwpath, bool maybe_compressed)
 {
+        char *skip_firmware = getenv("DRACUT_FIRMWARE_SKIP");
+        if (skip_firmware) {
+                return 0;
+        }
+
         const char *fw = fwpath;
         _cleanup_free_ char *fwpath_compressed = NULL;
         int ret;
