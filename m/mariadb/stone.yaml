#
# SPDX-FileCopyrightText: Â© 2020-2025 Serpent OS Developers
#
# SPDX-License-Identifier: MPL-2.0
#
name        : mariadb
version     : 11.8.2
release     : 1
upstreams   :
    - https://archive.mariadb.org/mariadb-11.8.2/source/mariadb-11.8.2.tar.gz : b2162cdf5e9317d8a8621cbeda83999324fc0ac8944210e14abb5fe0a9fea3ef
homepage    : https://mariadb.org/
license     :
    - BSD-3-Clause
    - GPL-2.0-or-later
    - LGPL-2.1-or-later
summary     : Message Digest functions from BSD systems
description : |
    MariaDB server is a community developed fork of MySQL server. Started by core members of the original MySQL team, MariaDB actively works with outside developers to deliver the most featureful, stable, and sanely licensed open SQL server in the industry.
builddeps   :
    - binary(bison)
    - binary(flex)
    - binary(m4)
    - cmake(Boost)
    - pkgconfig(bzip2)
    - pkgconfig(fmt)
    - pkgconfig(jemalloc)
    - pkgconfig(libcurl)
    - pkgconfig(liblz4)
    - pkgconfig(liblzma)
    - pkgconfig(libpcre2-8)
    - pkgconfig(libsystemd)
    - pkgconfig(libxml-2.0)
    - pkgconfig(libzstd)
    - pkgconfig(lzo2)
    - pkgconfig(ncursesw)
    - pkgconfig(openssl)
    - pkgconfig(pam)
    - pkgconfig(snappy)
    - binutils-devel
    - libaio-devel
    # TODO:
    # kytea
    # libzmq
    # msgpack
tuning      :
    - lto: false
setup       : |
    %patch %(pkgdir)/0001-Skip-components.patch

    %cmake \
        -DBUILD_CONFIG=mysql_release \
        -DCOMPILATION_COMMENT="AerynOS" \
        -DFEATURE_SET="community" \
        -DINSTALL_DOCDIR=share/doc/%(name) \
        -DINSTALL_DOCREADMEDIR=share/doc/%(name) \
        -DINSTALL_MANDIR=share/man \
        -DINSTALL_MYSQLSHAREDIR=share/%(name) \
        -DINSTALL_MYSQLTESTDIR= \
        -DINSTALL_PAMDIR=lib/security \
        -DINSTALL_PLUGINDIR=lib/%(name)/plugin \
        -DINSTALL_SBINDIR=sbin \
        -DINSTALL_SCRIPTDIR=bin \
        -DINSTALL_SQLBENCHDIR=share \
        -DINSTALL_SUPPORTFILESDIR=share/%(name) \
        -DINSTALL_SYSCONF2DIR="/usr/share/defaults/mysql/my.cnf.d" \
        -DINSTALL_SYSCONFDIR="/usr/share/defaults/mysql" \
        -DINSTALL_SYSTEMD_UNITDIR="%(libdir)/systemd/system" \
        -DMYSQL_DATADIR=/var/lib/mysql \
        -DMYSQL_UNIX_ADDR=/var/lib/mysql/mysqld.sock \
        -DSKIP_COMPONENTS="Test" \
        -DWITH_CURL=system \
        -DWITH_EMBEDDED_SERVER=ON \
        -DWITH_JEMALLOC=system \
        -DWITH_LIBFMT=system \
        -DWITH_PCRE=system \
        -DWITH_ROCKSDB_JEMALLOC=ON \
        -DWITH_SSL=system \
        -DWITH_UNIT_TESTS=OFF \
        -DWITH_ZLIB=system
build       : |
    %cmake_build
install     : |
    %cmake_install

    # Delete for now
    rm -rf %(installroot)/usr/share/sql-bench/
packages    :
    # TODO: Split out server, make sure it works

    - "libmariadb":
        rundeps:
            - "%(name)-config"
        paths:
            - /usr/lib/libmariadb.so.*
            - /usr/lib/mariadb/plugin/caching_sha2_password.so
            - /usr/lib/mariadb/plugin/client_ed25519.so
            - /usr/lib/mariadb/plugin/dialog.so
            - /usr/lib/mariadb/plugin/mysql_clear_password.so
            - /usr/lib/mariadb/plugin/parsec.so
            - /usr/lib/mariadb/plugin/sha256_password.so
            - /usr/lib/mariadb/plugin/zstd.so
            - /usr/share/defaults/mysql/my.cnf.d/client.cnf

    - "libmariadb-devel":
        rundeps:
            - libmariadb
        paths:
            - /usr/bin/mariadb-config
            - /usr/bin/mariadb_config
            - /usr/bin/mysql_config
            - /usr/include/mysql/*.h
            - /usr/include/mysql/mariadb/
            - /usr/include/mysql/mysql/
            - /usr/lib/libmariadb.so
            - /usr/lib/libmysqlclient*.so
            - /usr/lib/pkgconfig/libmariadb.pc
            - /usr/share/aclocal/mysql.m4
            - /usr/share/man/man3/

    - "libmariadb-staticlib":
        rundeps:
            - libmariadb-devel
        paths:
            - /usr/lib/libmariadb.a
            - /usr/lib/libmariadbclient.a
            - /usr/lib/libmysqlclient*.a
            - /usr/lib/libmysqlservices.a

    - "%(name)-common":
        paths:
            - /usr/share/mariadb/charsets/

    - "%(name)-config":
        paths:
            - /usr/share/defaults/mysql/my.cnf

    - "%(name)-embedded":
        summary: MariaDB as an embeddable library
        description: MariaDB as an embeddable library
        rundeps:
            - "%(name)-common"
            - "%(name)-errmsg"
        paths:
            - /usr/bin/mariadb-embedded
            - /usr/bin/mysql_embedded
            - /usr/lib/libmariadbd.so.*
            - /usr/share/man/man1/mariadb-embedded.*
            - /usr/share/man/man1/mysql_embedded.*

    # This might be wrong
    - "%(name)-embedded-devel":
        summary: Development files for %(name)-embedded
        description: Development files for %(name)-embedded
        rundeps:
            - "%(name)-embedded"
        paths:
            - /usr/include/mysql/server/
            - /usr/lib/libmariadbd.so
            - /usr/lib/libmysqld.so
            - /usr/lib/pkgconfig/mariadb.pc

    - "%(name)-embedded-staticlib":
        summary: Development files for %(name)-embedded - Static libraries
        description: Development files for %(name)-embedded - Static libraries
        rundeps:
            - "%(name)-devel"
        paths:
            - /usr/lib/libmariadbd.a
            - /usr/lib/libmysqld.a

    - "%(name)-errmsg":
        rundeps:
            - "%(name)-common"
        paths:
            - /usr/share/mariadb/**/errmsg.sys
