#
# SPDX-FileCopyrightText: Â© 2020-2024 Serpent OS Developers
#
# SPDX-License-Identifier: MPL-2.0
#
name        : mesa
version     : 25.2.1
# Note: keep mesa-clc in-sync with this package version-wise
release     : 46
homepage    : https://mesa3d.org/
upstreams   :
    - https://mesa.freedesktop.org/archive/mesa-25.2.1.tar.xz : c124372189d35f48e049ee503029171c68962c580971cb86d968a6771c965ba4
summary     : Mesa 3D graphics library
description : |
    The Mesa project began as an open-source implementation of the OpenGL specification - a system for rendering interactive 3D graphics. Over the years the project has grown to implement more graphics APIs, including OpenGL ES, OpenCL, OpenMAX, VDPAU, VA-API, Vulkan and EGL. A variety of device drivers allows the Mesa libraries to be used in many different environments ranging from software emulation to complete hardware acceleration for modern GPUs. Mesa ties into several other open-source projects: the Direct Rendering Infrastructure, X.org, and Wayland to provide OpenGL support on Linux, FreeBSD, and other operating systems.
license     :
    - BSD-2-Clause
    - MIT
networking  : true
builddeps   :
    - binary(bindgen)
    - binary(bison)
    - binary(cbindgen)
    - binary(flex)
    - binary(llvm-config32)
    - binary(mesa_clc)
    - binary(python3)
    - binary(rustc)
    - clang-32bit
    - clang-devel
    - cmake(Clang)
    - cmake(glslang)
    - gcc-32bit-devel
    - lm_sensors-devel
    - pkgconfig(libclc)
    # - pkgconfig(sysprof-capture-4)
    - pkgconfig(wayland-protocols)
    - pkgconfig32(LLVMSPIRVLib)
    - pkgconfig32(SPIRV-Tools)
    - pkgconfig32(expat)
    - pkgconfig32(libdrm)
    - pkgconfig32(libelf)
    - pkgconfig32(libglvnd)
    - pkgconfig32(libpng)
    - pkgconfig32(libudev)
    - pkgconfig32(libunwind)
    - pkgconfig32(libva)
    - pkgconfig32(libzstd)
    - pkgconfig32(vdpau)
    - pkgconfig32(x11)
    - pkgconfig32(xcb)
    - pkgconfig32(xcb-keysyms)
    - pkgconfig32(xext)
    - pkgconfig32(xfixes)
    - pkgconfig32(xrandr)
    - pkgconfig32(xshmfence)
    - pkgconfig32(xxf86vm)
    - pkgconfig32(zlib)
    - python(mako)
    - python(ply)
    - python(pyyaml)
    - libatomic-32bit
    - rust-32bit
tuning      :
    - lto: false
    - symbolic: false
    - optimize: speed
emul32      : true
profiles    :
    - emul32:
        environment: |
            export LLVM_CONFIG="llvm-config32"
            export RUSTC="rustc --target=%(target_triple)"
            export BINDGEN_EXTRA_CLANG_ARGS="--target=%(target_triple)"
            export EXTRA_VK_DRIVERS=""
        install     : |
            %meson_install
            ln -sv libGLX_mesa.so.0 %(installroot)%(libdir)/libGLX_indirect.so.0
environment : |
    EXTRA_VK_DRIVERS=",gfxstream,nouveau"
    _extra_args="-Dgallium-rusticl=true"
setup       : |
    # Include package release in version string so Chromium invalidates
    # its GPU cache; otherwise it can cause pages to render incorrectly.
    # https://issues.chromium.org/issues/40267041
    # Note that this was fixed in upstream Chromium in Mar 2024 and backported
    # to supported Electron releases shortly thereafter. This workaround can
    # probably be removed around the end of 2025 as the only affect apps will
    # those using old versions of Electron.
    echo "%(version)-aeryn.%(release)" >VERSION

    %patch %(pkgdir)/0001-Install-opencl-ICD-to-datadir.patch

    # Fix build with Sphinx 8.2
    %patch %(pkgdir)/0001-docs-Fix-build-with-Sphinx-8.2.patch

    # TODO: Do we want to enable sysprof (-dsysprof=true)?
    # sysprof causes segfaults in mpv: https://gitlab.freedesktop.org/mesa/mesa/-/issues/13571
    %meson \
        -Degl=enabled \
        -Dgallium-drivers=crocus,i915,iris,llvmpipe,nouveau,r300,r600,radeonsi,softpipe,svga,virgl,zink \
        -Dgallium-extra-hud=true \
        -Dgallium-va=enabled \
        -Dgallium-vdpau=enabled \
        -Dgbm=enabled \
        -Dgles1=disabled \
        -Dglvnd=enabled \
        -Dllvm=enabled \
        -Dmesa-clc=system \
        -Dzstd=enabled \
        -Dplatforms=x11,wayland \
        -Dshared-llvm=enabled \
        -Dvideo-codecs=all \
        -Dmicrosoft-clc=disabled \
        -Dvulkan-drivers=amd,intel,intel_hasvk,swrast,virtio$EXTRA_VK_DRIVERS \
        -Dvulkan-layers=device-select,overlay,screenshot,vram-report-limit \
        --wrap-mode=default \
        $_extra_args
build       : |
    %meson_build
install     : |
    %meson_install
    ln -sv libGLX_mesa.so.0 %(installroot)%(libdir)/libGLX_indirect.so.0

    %install_dir %(installroot)%(docdir)/%(name)
    echo "This file will disappear when virtual packages are introduced" > %(installroot)%(docdir)/%(name)/README

    %install_dir %(installroot)%(docdir)/%(name)-devel
    echo "DEPRECATED" > %(installroot)%(docdir)/%(name)-devel/README
packages    :
    - "libgbm":
        summary: Mesa gbm runtime library
        description: Mesa gbm runtime library
        paths:
            - /usr/lib/libgbm.so.*

    - "libgbm-devel":
        summary: Mesa gbm runtime library - devel
        description: Mesa gbm runtime library - devel
        rundeps:
            - "libgbm"
        paths:
            - /usr/include/gbm*.h
            - /usr/lib/pkgconfig/gbm.pc
            - /usr/lib/libgbm.so

    - "%(name)-libgl":
        summary: Mesa libGL runtime libraries
        description: Mesa libGL runtime libraries
        rundeps:
            - libglvnd-glx
        paths:
            - /usr/lib/libGLX_mesa.so.*
            - /usr/lib/libGLX_indirect.so.*

    - "%(name)-libgl-devel":
        summary: Mesa libGL runtime libraries - devel
        description: Mesa libGL runtime libraries - devel
        rundeps:
            - "%(name)-libgl"
        paths:
            - /usr/include/GL
            - /usr/lib/pkgconfig/dri.pc
            - /usr/lib/libGLX_mesa.so

    - "%(name)-libegl":
        summary: Mesa libEGL runtime libraries
        description: Mesa libEGL runtime libraries
        rundeps:
            - libglvnd-egl

            # For unknown reasons it appears that this gets dlopened sometimes during EGL init
            # if libGLESv2.so isn't present whatever called it will fail even though it would work
            # perfectly fine if mesa were built without GLESv2 support. Just add it as a rundep until
            # the cause is known, or we stop supporting GLESv2

            # Currently this is known to happen when clicking the tab overview in ptyxis
            - libglvnd-gles
        paths:
            - /usr/lib/libEGL_mesa.so.*
            - /usr/share/glvnd

    - "%(name)-libegl-devel":
        summary: Mesa libEGL runtime libraries - devel
        description: Mesa libEGL runtime libraries - devel
        rundeps:
            - "%(name)-libegl"
        paths:
            - /usr/include/EGL
            - /usr/lib/libEGL_mesa.so

    - "%(name)-libopencl":
        summary: Mesa OpenCL runtime library
        description: Mesa OpenCL runtime library
        rundeps:
            # This might need additional deps
            - ocl-icd
        paths:
            - /usr/lib/libRusticlOpenCL.so*
            - /usr/share/OpenCL/

    - "%(name)-dri-drivers":
        summary: Mesa-based DRI drivers (includes VAAPI/VDPAU support)
        description: Mesa-based DRI drivers (includes VAAPI/VDPAU support)
        paths:
            - /usr/lib/dri/*.so
            - /usr/lib/dri/*drv_video.so
            - /usr/lib/gbm/dri_gbm.so
            - /usr/lib/libgallium-*.so
            - /usr/lib/vdpau/
            - /usr/share/drirc.d/00-mesa-defaults.conf

    - "%(name)-vulkan-drivers":
        summary: Mesa Vulkan drivers
        description: Mesa Vulkan drivers
        rundeps:
            - vulkan-loader
        paths:
            - /usr/lib/libvulkan_*.so
            - /usr/lib/libVkLayer_MESA_device_select.so
            - /usr/share/drirc.d/00-radv-defaults.conf
            - /usr/share/vulkan/icd.d/*.x86_64.json
            - /usr/share/vulkan/implicit_layer.d/VkLayer_MESA_device_select.json

    - "%(name)-vulkan-layers":
        summary: Additional Mesa Vulkan layers
        description: Additional Mesa Vulkan layers
        paths:
            - /usr/bin/*.py
            - /usr/lib/libVkLayer_MESA_overlay.so
            - /usr/lib/libVkLayer_MESA_screenshot.so
            - /usr/lib/libVkLayer_MESA_vram_report_limit.so
            - /usr/share/vulkan/explicit_layer.d

    - "%(name)-32bit":
        paths:
            - /usr/lib32/libgallium*.so
            - /usr/lib32/libVk*.so
            - /usr/lib32/libvulkan_*.so
            - /usr/share/vulkan/icd.d/*.i686.json

    - "%(name)":
        summary: Meta-package for Mesa drivers
        description: Meta-package for Mesa drivers
        rundeps:
            - "%(name)-dri-drivers"
            - "%(name)-libegl"
            - "%(name)-libgl"
            - "%(name)-vulkan-drivers"

    - "%(name)-devel":
        summary: Deprecated package
        description: Deprecated package
        rundeps:
            - libgbm-devel
            - "%(name)-libgl-devel"
            - "%(name)-libegl-devel"
        paths:
            - /usr/share/doc/mesa-devel/README
