#
# SPDX-FileCopyrightText: Â© 2020-2024 Serpent OS Developers
#
# SPDX-License-Identifier: MPL-2.0
#
name        : mesa
version     : 25.3.4
# Note: keep mesa-clc in-sync with this package version-wise
release     : 64
homepage    : https://mesa3d.org/
upstreams   :
    - https://mesa.freedesktop.org/archive/mesa-25.3.4.tar.xz : 3a0fc6ec070b45ae25dc2ccb5e52fae1d89141f7c39c4a91fe4eaa80dfff9deb
##@@BEGIN_UPSTREAMS
    - https://crates.io/api/v1/crates/bitflags/2.9.1/download:
        hash: 1b8e56985ec62d17e9c1001dc89c88ecd7dc08e47eba5ec7c29c7b5eeecde967
        rename: bitflags-2.9.1.tar.gz
        unpack: false
    - https://crates.io/api/v1/crates/cfg-if/1.0.0/download:
        hash: baf1de4339761588bc0619e3cbc0120ee582ebb74b53b4efbf79117bd2da40fd
        rename: cfg-if-1.0.0.tar.gz
        unpack: false
    - https://crates.io/api/v1/crates/equivalent/1.0.1/download:
        hash: 5443807d6dff69373d433ab9ef5378ad8df50ca6298caf15de6e52e24aaf54d5
        rename: equivalent-1.0.1.tar.gz
        unpack: false
    - https://crates.io/api/v1/crates/errno/0.3.12/download:
        hash: cea14ef9355e3beab063703aa9dab15afd25f0667c341310c1e5274bb1d0da18
        rename: errno-0.3.12.tar.gz
        unpack: false
    - https://crates.io/api/v1/crates/hashbrown/0.14.1/download:
        hash: 7dfda62a12f55daeae5015f81b0baea145391cb4520f86c248fc615d72640d12
        rename: hashbrown-0.14.1.tar.gz
        unpack: false
    - https://crates.io/api/v1/crates/indexmap/2.2.6/download:
        hash: 168fb715dda47215e360912c096649d23d58bf392ac62f73919e831745e40f26
        rename: indexmap-2.2.6.tar.gz
        unpack: false
    - https://crates.io/api/v1/crates/libc/0.2.171/download:
        hash: c19937216e9d3aa9956d9bb8dfc0b0c8beb6058fc4f7a4dc4d850edf86a237d6
        rename: libc-0.2.171.tar.gz
        unpack: false
    - https://crates.io/api/v1/crates/log/0.4.27/download:
        hash: 13dc2df351e3202783a1fe0d44375f7295ffb4049267b0f3018346dc122a1d94
        rename: log-0.4.27.tar.gz
        unpack: false
    - https://crates.io/api/v1/crates/once_cell/1.8.0/download:
        hash: 692fcb63b64b1758029e0a96ee63e049ce8c5948587f2f7208df04625e5f6b56
        rename: once_cell-1.8.0.tar.gz
        unpack: false
    - https://crates.io/api/v1/crates/paste/1.0.14/download:
        hash: de3145af08024dea9fa9914f381a17b8fc6034dfb00f3a84013f7ff43f29ed4c
        rename: paste-1.0.14.tar.gz
        unpack: false
    - https://crates.io/api/v1/crates/pest/2.8.0/download:
        hash: 198db74531d58c70a361c42201efde7e2591e976d518caf7662a47dc5720e7b6
        rename: pest-2.8.0.tar.gz
        unpack: false
    - https://crates.io/api/v1/crates/pest_derive/2.8.0/download:
        hash: d725d9cfd79e87dccc9341a2ef39d1b6f6353d68c4b33c177febbe1a402c97c5
        rename: pest_derive-2.8.0.tar.gz
        unpack: false
    - https://crates.io/api/v1/crates/pest_generator/2.8.0/download:
        hash: db7d01726be8ab66ab32f9df467ae8b1148906685bbe75c82d1e65d7f5b3f841
        rename: pest_generator-2.8.0.tar.gz
        unpack: false
    - https://crates.io/api/v1/crates/pest_meta/2.8.0/download:
        hash: 7f9f832470494906d1fca5329f8ab5791cc60beb230c74815dff541cbd2b5ca0
        rename: pest_meta-2.8.0.tar.gz
        unpack: false
    - https://crates.io/api/v1/crates/proc-macro2/1.0.86/download:
        hash: 5e719e8df665df0d1c8fbfd238015744736151d4445ec0836b8e628aae103b77
        rename: proc-macro2-1.0.86.tar.gz
        unpack: false
    - https://crates.io/api/v1/crates/quote/1.0.35/download:
        hash: 291ec9ab5efd934aaf503a6466c5d5251535d108ee747472c3977cc5acc868ef
        rename: quote-1.0.35.tar.gz
        unpack: false
    - https://crates.io/api/v1/crates/remain/0.2.12/download:
        hash: 1ad5e011230cad274d0532460c5ab69828ea47ae75681b42a841663efffaf794
        rename: remain-0.2.12.tar.gz
        unpack: false
    - https://crates.io/api/v1/crates/roxmltree/0.20.0/download:
        hash: 6c20b6793b5c2fa6553b250154b78d6d0db37e72700ae35fad9387a46f487c97
        rename: roxmltree-0.20.0.tar.gz
        unpack: false
    - https://crates.io/api/v1/crates/rustc-hash/2.1.1/download:
        hash: 357703d41365b4b27c590e3ed91eabb1b663f07c4c084095e60cbed4362dff0d
        rename: rustc-hash-2.1.1.tar.gz
        unpack: false
    - https://crates.io/api/v1/crates/rustix/1.1.2/download:
        hash: cd15f8a2c5551a84d56efdc1cd049089e409ac19a3072d5037a17fd70719ff3e
        rename: rustix-1.1.2.tar.gz
        unpack: false
    - https://crates.io/api/v1/crates/syn/2.0.87/download:
        hash: 25aa4ce346d03a6dcd68dd8b4010bcb74e54e62c90c573f394c46eae99aba32d
        rename: syn-2.0.87.tar.gz
        unpack: false
    - https://crates.io/api/v1/crates/thiserror/2.0.11/download:
        hash: d452f284b73e6d76dd36758a0c8684b1d5be31f92b89d07fd5822175732206fc
        rename: thiserror-2.0.11.tar.gz
        unpack: false
    - https://crates.io/api/v1/crates/thiserror-impl/2.0.11/download:
        hash: 26afc1baea8a989337eeb52b6e72a039780ce45c3edfcc9c5b9d112feeb173c2
        rename: thiserror-impl-2.0.11.tar.gz
        unpack: false
    - https://crates.io/api/v1/crates/ucd-trie/0.1.6/download:
        hash: ed646292ffc8188ef8ea4d1e0e0150fb15a5c2e12ad9b8fc191ae7a8a7f3c4b9
        rename: ucd-trie-0.1.6.tar.gz
        unpack: false
    - https://crates.io/api/v1/crates/unicode-ident/1.0.12/download:
        hash: 3354b9ac3fae1ff6755cb6db53683adb661634f67557942dea4facebec0fee4b
        rename: unicode-ident-1.0.12.tar.gz
        unpack: false
    - https://crates.io/api/v1/crates/windows-link/0.2.0/download:
        hash: 45e46c0661abb7180e7b9c281db115305d49ca1709ab8242adf09666d2173c65
        rename: windows-link-0.2.0.tar.gz
        unpack: false
    - https://crates.io/api/v1/crates/windows-sys/0.61.1/download:
        hash: 6f109e41dd4a3c848907eb83d5a42ea98b3769495597450cf6d153507b166f0f
        rename: windows-sys-0.61.1.tar.gz
        unpack: false
    - https://crates.io/api/v1/crates/zerocopy/0.8.13/download:
        hash: 67914ab451f3bfd2e69e5e9d2ef3858484e7074d63f204fd166ec391b54de21d
        rename: zerocopy-0.8.13.tar.gz
        unpack: false
    - https://crates.io/api/v1/crates/zerocopy-derive/0.8.13/download:
        hash: 7988d73a4303ca289df03316bc490e934accf371af6bc745393cf3c2c5c4f25d
        rename: zerocopy-derive-0.8.13.tar.gz
        unpack: false
##@@END_UPSTREAMS
summary     : Mesa 3D graphics library
description : |
    The Mesa project began as an open-source implementation of the OpenGL specification - a system for rendering interactive 3D graphics. Over the years the project has grown to implement more graphics APIs, including OpenGL ES, OpenCL, OpenMAX, VDPAU, VA-API, Vulkan and EGL. A variety of device drivers allows the Mesa libraries to be used in many different environments ranging from software emulation to complete hardware acceleration for modern GPUs. Mesa ties into several other open-source projects: the Direct Rendering Infrastructure, X.org, and Wayland to provide OpenGL support on Linux, FreeBSD, and other operating systems.
license     :
    - BSD-2-Clause
    - MIT
builddeps   :
    - binary(bindgen)
    - binary(bison)
    - binary(cbindgen)
    - binary(flex)
    - binary(llvm-config32)
    - binary(mesa_clc)
    - binary(python3)
    - binary(rustc)
    - binary(rustfmt) # Probably can be removed in next version
    - cmake(Clang)
    - cmake(glslang)
    - cmake(libxml2)
    - pkgconfig(libarchive)
    - pkgconfig(libclc)
    - pkgconfig(libdisplay-info)
    - pkgconfig(sysprof-capture-4)
    - pkgconfig(wayland-protocols)
    - pkgconfig32(LLVMSPIRVLib)
    - pkgconfig32(SPIRV-Tools)
    - pkgconfig32(expat)
    - pkgconfig32(libdrm)
    - pkgconfig32(libelf)
    - pkgconfig32(libglvnd)
    - pkgconfig32(libpng)
    - pkgconfig32(libudev)
    - pkgconfig32(libunwind)
    - pkgconfig32(libva)
    - pkgconfig32(libzstd)
    - pkgconfig32(vdpau)
    - pkgconfig32(x11)
    - pkgconfig32(xcb)
    - pkgconfig32(xcb-keysyms)
    - pkgconfig32(xext)
    - pkgconfig32(xfixes)
    - pkgconfig32(xrandr)
    - pkgconfig32(xshmfence)
    - pkgconfig32(xxf86vm)
    - pkgconfig32(zlib)
    - python(mako)
    - python(ply)
    - python(pyyaml)
    - clang-32bit
    - clang-devel
    - gcc-32bit-devel
    - libatomic-32bit
    - lm_sensors-devel
    - rust-32bit
tuning      :
    - lto: false
    - symbolic: false
    - optimize: speed
emul32      : true
profiles    :
    - emul32:
        environment: |
            _IS_64BIT_BOOL="false"
            _IS_64BIT_FEAT="disabled"

            export LLVM_CONFIG="llvm-config32"
            export RUSTC="rustc --target=%(target_triple)"
            export BINDGEN_EXTRA_CLANG_ARGS="--target=%(target_triple)"
            export EXTRA_VK_DRIVERS=""
        install     : |
            %meson_install
            ln -sv libGLX_mesa.so.0 %(installroot)%(libdir)/libGLX_indirect.so.0
environment : |
    _IS_64BIT_BOOL="true"
    _IS_64BIT_FEAT="enabled"

    EXTRA_VK_DRIVERS=",gfxstream,nouveau"
setup       : |
    %patch %(pkgdir)/0001-Install-opencl-ICD-to-datadir.patch

    # Fix build with Sphinx 8.2
    %patch %(pkgdir)/0001-docs-Fix-build-with-Sphinx-8.2.patch

    # Fix build with glibc 2.43
    %patch %(pkgdir)/38594.patch
    %patch %(pkgdir)/0001-ftbfs-glibc-2.43.patch

    # intel ANV texture bug fix https://gitlab.freedesktop.org/mesa/mesa/-/issues/14684
    export CXXFLAGS+=" -fno-strict-aliasing"

    export MESON_PACKAGE_CACHE_DIR=%(sourcedir)

    %meson \
        -Ddisplay-info=${_IS_64BIT_FEAT} \
        -Degl=enabled \
        -Dgallium-drivers=crocus,i915,iris,llvmpipe,nouveau,r300,r600,radeonsi,softpipe,svga,virgl,zink \
        -Dgallium-extra-hud=true \
        -Dgallium-rusticl=${_IS_64BIT_BOOL} \
        -Dgallium-va=enabled \
        -Dgbm=enabled \
        -Dgles1=disabled \
        -Dglvnd=enabled \
        -Dllvm=enabled \
        -Dmesa-clc=system \
        -Dsysprof=${_IS_64BIT_BOOL} \
        -Dzstd=enabled \
        -Dplatforms=x11,wayland \
        -Dshared-llvm=enabled \
        -Dvideo-codecs=all \
        -Dmicrosoft-clc=disabled \
        -Dvulkan-drivers=amd,intel,intel_hasvk,swrast,virtio$EXTRA_VK_DRIVERS \
        -Dvulkan-layers=anti-lag,device-select,overlay,screenshot,vram-report-limit
build       : |
    %meson_build
install     : |
    %meson_install
    ln -sv libGLX_mesa.so.0 %(installroot)%(libdir)/libGLX_indirect.so.0

    %install_dir %(installroot)%(docdir)/%(name)
    echo "This file will disappear when virtual packages are introduced" > %(installroot)%(docdir)/%(name)/README

    %install_dir %(installroot)%(docdir)/%(name)-devel
    echo "DEPRECATED" > %(installroot)%(docdir)/%(name)-devel/README
packages    :
    - "libgbm":
        summary: Mesa gbm runtime library
        description: Mesa gbm runtime library
        paths:
            - /usr/lib/libgbm.so.*

    - "libgbm-devel":
        summary: Mesa gbm runtime library - devel
        description: Mesa gbm runtime library - devel
        rundeps:
            - "libgbm"
        paths:
            - /usr/include/gbm*.h
            - /usr/lib/pkgconfig/gbm.pc
            - /usr/lib/libgbm.so

    - "%(name)-libgl":
        summary: Mesa libGL runtime libraries
        description: Mesa libGL runtime libraries
        rundeps:
            - libglvnd-glx
        paths:
            - /usr/lib/libGLX_mesa.so.*
            - /usr/lib/libGLX_indirect.so.*

    - "%(name)-libgl-devel":
        summary: Mesa libGL runtime libraries - devel
        description: Mesa libGL runtime libraries - devel
        rundeps:
            - "%(name)-libgl"
        paths:
            - /usr/include/GL
            - /usr/lib/pkgconfig/dri.pc
            - /usr/lib/libGLX_mesa.so

    - "%(name)-libegl":
        summary: Mesa libEGL runtime libraries
        description: Mesa libEGL runtime libraries
        rundeps:
            - libglvnd-egl

            # For unknown reasons it appears that this gets dlopened sometimes during EGL init
            # if libGLESv2.so isn't present whatever called it will fail even though it would work
            # perfectly fine if mesa were built without GLESv2 support. Just add it as a rundep until
            # the cause is known, or we stop supporting GLESv2

            # Currently this is known to happen when clicking the tab overview in ptyxis
            - libglvnd-gles
        paths:
            - /usr/lib/libEGL_mesa.so.*
            - /usr/share/glvnd

    - "%(name)-libegl-devel":
        summary: Mesa libEGL runtime libraries - devel
        description: Mesa libEGL runtime libraries - devel
        rundeps:
            - "%(name)-libegl"
        paths:
            - /usr/include/EGL
            - /usr/lib/libEGL_mesa.so

    - "%(name)-libopencl":
        summary: Mesa OpenCL runtime library
        description: Mesa OpenCL runtime library
        rundeps:
            # This might need additional deps
            - ocl-icd
        paths:
            - /usr/lib/libRusticlOpenCL.so*
            - /usr/share/OpenCL/

    - "%(name)-dri-drivers":
        summary: Mesa-based DRI drivers (includes VAAPI/VDPAU support)
        description: Mesa-based DRI drivers (includes VAAPI/VDPAU support)
        paths:
            - /usr/lib/dri/*.so
            - /usr/lib/dri/*drv_video.so
            - /usr/lib/gbm/dri_gbm.so
            - /usr/lib/libgallium-*.so
            - /usr/share/drirc.d/00-mesa-defaults.conf

    - "%(name)-vulkan-drivers":
        summary: Mesa Vulkan drivers
        description: Mesa Vulkan drivers
        rundeps:
            - vulkan-loader
        paths:
            - /usr/lib/libvulkan_*.so
            - /usr/lib/libVkLayer_MESA_anti_lag.so
            - /usr/lib/libVkLayer_MESA_device_select.so
            - /usr/share/drirc.d/00-radv-defaults.conf
            - /usr/share/vulkan/icd.d/*.x86_64.json
            - /usr/share/vulkan/implicit_layer.d/VkLayer_MESA_anti_lag.json
            - /usr/share/vulkan/implicit_layer.d/VkLayer_MESA_device_select.json

    - "%(name)-vulkan-layers":
        summary: Additional Mesa Vulkan layers
        description: Additional Mesa Vulkan layers
        paths:
            - /usr/bin/*.py
            - /usr/lib/libVkLayer_MESA_overlay.so
            - /usr/lib/libVkLayer_MESA_screenshot.so
            - /usr/lib/libVkLayer_MESA_vram_report_limit.so
            - /usr/share/vulkan/explicit_layer.d

    - "%(name)-32bit":
        paths:
            - /usr/lib32/libgallium*.so
            - /usr/lib32/libVk*.so
            - /usr/lib32/libvulkan_*.so
            - /usr/share/vulkan/icd.d/*.i686.json

    - "%(name)":
        summary: Meta-package for Mesa drivers
        description: Meta-package for Mesa drivers
        rundeps:
            - "%(name)-dri-drivers"
            - "%(name)-libegl"
            - "%(name)-libgl"
            - "%(name)-vulkan-drivers"

    - "%(name)-devel":
        summary: Deprecated package
        description: Deprecated package
        rundeps:
            - libgbm-devel
            - "%(name)-libgl-devel"
            - "%(name)-libegl-devel"
        paths:
            - /usr/share/doc/mesa-devel/README
