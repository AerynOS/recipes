#
# SPDX-FileCopyrightText: Â© 2020-2024 Serpent OS Developers
#
# SPDX-License-Identifier: MPL-2.0
#
name        : linux-pam
version     : 1.7.1
release     : 17
summary     : Pluggable Authentication Modules
license     :
    - BSD-3-Clause
    - GPL-3.0-or-later
homepage    : http://www.linux-pam.org/
description : |
    Pluggable Authentication Modules
upstreams   :
    - https://github.com/linux-pam/linux-pam/releases/download/v1.7.1/Linux-PAM-1.7.1.tar.xz: 21dbcec6e01dd578f14789eac9024a18941e6f2702a05cf91b28c232eeb26ab0
builddeps   :
    - binary(bison)
    - binary(flex)
    - binary(gettext)
    - binary(xsltproc)
    - pkgconfig32(libeconf)
    - pkgconfig32(libsystemd)
    - pkgconfig32(libxcrypt)
    - docbook-xsl
    - docbook5-xml
emul32      : true
profiles    :
    - emul32:
        install: |
            %meson_install

            # _PROBABLY_ not needed, re-add if that assumption is false
            rm -rfv %(installroot)%(libdir)/security
environment : |
    # Temporary, replace with boulder macro
    export XML_CATALOG_FILES="file:///usr/share/defaults/docbook/docbook5-xml/catalog file:///usr/share/defaults/docbook/docbook-xsl/catalog"
setup       : |
    # version script assignment of 'global' to symbol 'pam_sm_chauthtok' failed: symbol not defined
    export LDFLAGS="${LDFLAGS} -Wl,--undefined-version"

    %meson \
        -Dvendordir=%(vendordir)
build       : |
    %meson_build
install     : |
    %meson_install

    %install_file %(pkgdir)/pam.d/* -t %(installroot)/%(vendordir)/pam.d
    %install_file %(pkgdir)/conf/shells -t %(installroot)/%(vendordir)/.

    # Ensure that this environmental variable is always set
    %install_file %(pkgdir)/conf/XDG_CONFIG_DIRS.environment %(installroot)/usr/share/defaults/environment.d/XDG_CONFIG_DIRS.conf

    %tmpfiles "# Create run/faillock directory"
    %tmpfiles "d /run/faillock 0755 root root -"

    # add ability to check pwd for any user instead only the current (required by cosmic-greeter)
    chmod u+s %(installroot)/usr/sbin/unix_chkpwd
packages    :
    - "%(name)-docs":
        paths:
            - /usr/share/doc

    - "%(name)-libs":
        summary: "Library files for %(name)"
        description: |
            Library files for %(name), typically pulled in as a dependency of another package.
        paths:
            - /usr/lib/lib*.so.*

    # Moss upgrade issue
    - "%(name)":
        rundeps:
            - "%(name)-libs"
