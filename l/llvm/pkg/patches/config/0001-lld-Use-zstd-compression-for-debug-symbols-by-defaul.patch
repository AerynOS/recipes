From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Reilly Brogan <reilly@reillybrogan.com>
Date: Thu, 12 Dec 2024 20:50:14 -0600
Subject: [PATCH] lld: Use zstd compression for debug symbols by default

This causes LLVM to always behave as though `--compress-debug-sections=zstd` is present.

It would be nice if llvm supported configuring this at build time like binutils does.
---
 clang/include/clang/Driver/Options.td  |  4 ++--
 clang/tools/driver/cc1as_main.cpp      |  4 ++--
 lld/ELF/Config.h                       |  2 +-
 lld/ELF/Driver.cpp                     | 10 +++++-----
 lld/ELF/Options.td                     |  2 +-
 llvm/tools/llvm-objcopy/ObjcopyOpts.td |  4 ++--
 6 files changed, 13 insertions(+), 13 deletions(-)

diff --git a/clang/include/clang/Driver/Options.td b/clang/include/clang/Driver/Options.td
index b8d1608a1453..b517f4aadb51 100644
--- a/clang/include/clang/Driver/Options.td
+++ b/clang/include/clang/Driver/Options.td
@@ -6781,9 +6781,9 @@ def record_command_line : Separate<["-"], "record-command-line">,
 def compress_debug_sections_EQ : Joined<["-", "--"], "compress-debug-sections=">,
     HelpText<"DWARF debug sections compression type">, Values<"none,zlib,zstd">,
     NormalizedValuesScope<"llvm::DebugCompressionType">, NormalizedValues<["None", "Zlib", "Zstd"]>,
-    MarshallingInfoEnum<CodeGenOpts<"CompressDebugSections">, "None">;
+    MarshallingInfoEnum<CodeGenOpts<"CompressDebugSections">, "Zstd">;
 def compress_debug_sections : Flag<["-", "--"], "compress-debug-sections">,
-  Alias<compress_debug_sections_EQ>, AliasArgs<["zlib"]>;
+  Alias<compress_debug_sections_EQ>, AliasArgs<["zstd"]>;
 def mno_exec_stack : Flag<["-"], "mnoexecstack">,
   HelpText<"Mark the file as not needing an executable stack">,
   MarshallingInfoFlag<CodeGenOpts<"NoExecStack">>;
diff --git a/clang/tools/driver/cc1as_main.cpp b/clang/tools/driver/cc1as_main.cpp
index bc398fa0731f..62bdf73939da 100644
--- a/clang/tools/driver/cc1as_main.cpp
+++ b/clang/tools/driver/cc1as_main.cpp
@@ -100,7 +100,7 @@ struct AssemblerInvocation {
   std::string DebugCompilationDir;
   llvm::SmallVector<std::pair<std::string, std::string>, 0> DebugPrefixMap;
   llvm::DebugCompressionType CompressDebugSections =
-      llvm::DebugCompressionType::None;
+      llvm::DebugCompressionType::Zstd;
   std::string MainFileName;
   std::string SplitDwarfOutput;
 
@@ -263,7 +263,7 @@ bool AssemblerInvocation::CreateFromArgs(AssemblerInvocation &Opts,
             .Case("none", llvm::DebugCompressionType::None)
             .Case("zlib", llvm::DebugCompressionType::Zlib)
             .Case("zstd", llvm::DebugCompressionType::Zstd)
-            .Default(llvm::DebugCompressionType::None);
+            .Default(llvm::DebugCompressionType::Zstd);
   }
 
   Opts.RelaxELFRelocations = !Args.hasArg(OPT_mrelax_relocations_no);
diff --git a/lld/ELF/Config.h b/lld/ELF/Config.h
index 3a4a47d900fe..0ec8ea5b144c 100644
--- a/lld/ELF/Config.h
+++ b/lld/ELF/Config.h
@@ -221,7 +221,7 @@ struct Config {
   CGProfileSortKind callGraphProfileSort;
   bool checkSections;
   bool checkDynamicRelocs;
-  llvm::DebugCompressionType compressDebugSections;
+  llvm::DebugCompressionType compressDebugSections = llvm::DebugCompressionType::Zstd;
   bool cref;
   llvm::SmallVector<std::pair<llvm::GlobPattern, uint64_t>, 0>
       deadRelocInNonAlloc;
diff --git a/lld/ELF/Driver.cpp b/lld/ELF/Driver.cpp
index 8079be691436..2225aeb0c80c 100644
--- a/lld/ELF/Driver.cpp
+++ b/lld/ELF/Driver.cpp
@@ -1086,10 +1086,10 @@ static CGProfileSortKind getCGProfileSortKind(opt::InputArgList &args) {
 static DebugCompressionType getCompressionType(StringRef s, StringRef option) {
   DebugCompressionType type = StringSwitch<DebugCompressionType>(s)
                                   .Case("zlib", DebugCompressionType::Zlib)
-                                  .Case("zstd", DebugCompressionType::Zstd)
-                                  .Default(DebugCompressionType::None);
-  if (type == DebugCompressionType::None) {
-    if (s != "none")
+                                  .Case("none", DebugCompressionType::None)
+                                  .Default(DebugCompressionType::Zstd);
+  if (type == DebugCompressionType::Zstd) {
+    if (s != "zstd")
       error("unknown " + option + " value: " + s);
   } else if (const char *reason = compression::getReasonIfUnsupported(
                  compression::formatFor(type))) {
@@ -1225,7 +1225,7 @@ static void readConfigs(opt::InputArgList &args) {
       args.hasFlag(OPT_check_sections, OPT_no_check_sections, true);
   config->chroot = args.getLastArgValue(OPT_chroot);
   config->compressDebugSections = getCompressionType(
-      args.getLastArgValue(OPT_compress_debug_sections, "none"),
+      args.getLastArgValue(OPT_compress_debug_sections, "zstd"),
       "--compress-debug-sections");
   config->cref = args.hasArg(OPT_cref);
   config->optimizeBBJumps =
diff --git a/lld/ELF/Options.td b/lld/ELF/Options.td
index 35d9c5ffa29b..2cc5c296c0ca 100644
--- a/lld/ELF/Options.td
+++ b/lld/ELF/Options.td
@@ -64,7 +64,7 @@ defm check_sections: B<"check-sections",
     "Do not check section addresses for overlaps">;
 
 defm compress_debug_sections:
-  Eq<"compress-debug-sections", "Compress DWARF debug sections">,
+  Eq<"compress-debug-sections", "Compress DWARF debug sections (default: zstd)">,
   MetaVarName<"[none,zlib,zstd]">;
 
 defm defsym: Eq<"defsym", "Define a symbol alias">, MetaVarName<"<symbol>=<value>">;
diff --git a/llvm/tools/llvm-objcopy/ObjcopyOpts.td b/llvm/tools/llvm-objcopy/ObjcopyOpts.td
index ead8cd28d387..16b3dd8830ae 100644
--- a/llvm/tools/llvm-objcopy/ObjcopyOpts.td
+++ b/llvm/tools/llvm-objcopy/ObjcopyOpts.td
@@ -33,9 +33,9 @@ def compress_debug_sections
     : Joined<["--"], "compress-debug-sections=">,
       MetaVarName<"format">,
       HelpText<"Compress DWARF debug sections using specified format. Supported "
-               "formats: zlib, zstd. Select zlib if <format> is omitted">;
+               "formats: zlib, zstd. Select zstd if <format> is omitted.">;
 def : Flag<["--"], "compress-debug-sections">, Alias<compress_debug_sections>,
-      AliasArgs<["zlib"]>;
+      AliasArgs<["zstd"]>;
 def decompress_debug_sections : Flag<["--"], "decompress-debug-sections">,
                                 HelpText<"Decompress DWARF debug sections">;
 defm split_dwo
