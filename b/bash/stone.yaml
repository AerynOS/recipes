#
# SPDX-FileCopyrightText: Â© 2020-2024 Serpent OS Developers
#
# SPDX-License-Identifier: MPL-2.0
#
name        : bash
version     : 5.3.3
release     : 25
homepage    : http://www.gnu.org/software/bash/bash.html
upstreams   :
    # Use a mirror because the GNU http server is flaky AF
    # - https://ftp.gnu.org/gnu/bash/bash-5.3.tar.gz : 0d5cd86965f869a26cf64f4b71be7b96f90a3ba8b3d74e27e8e9d9d5550f31ba
    - https://mirror.kumi.systems/gnu/bash/bash-5.3.tar.gz : 0d5cd86965f869a26cf64f4b71be7b96f90a3ba8b3d74e27e8e9d9d5550f31ba
summary     : GNU Bourne-Again Shell
description : |
    Bash is a sh-compatible command interpreter that executes
    commands read from the standard input or from a file.
    Bash also incorporates useful features from the Korn and
    C shells (ksh and csh).  Bash is ultimately intended to
    be a conformant implementation of the IEEE Posix Shell
    and Tools specification (IEEE Working Group 1003.2)
license     :
    - GPL-3.0-or-later
builddeps   :
    - binary(bison)
    - pkgconfig(ncursesw)
    - pkgconfig(readline)
setup       : |
    # TODO: We need a reliable method to see if there are patches upstream. Possible a custom check in ent

    %patch %(pkgdir)/bash53-001 -p0
    %patch %(pkgdir)/bash53-002 -p0
    %patch %(pkgdir)/bash53-003 -p0

    %patch %(pkgdir)/stateless.patch

    export CFLAGS="$CFLAGS -DRECYCLES_PIDS -DSYSLOG_HISTORY -DSYSLOG_SHOPT=0 -DDEFAULT_PATH_VALUE='\"/usr/local/bin:/usr/local/sbin:/usr/bin:/usr/sbin\"'"

    # often hangs
    rm tests/run-jobs

    # ensure that while this build is ongoing, /usr/bin/sh is guaranteed to
    # exist and be owned by bash.
    [[ -f /usr/bin/sh ]] && ls -l /usr/bin/sh && rm -vf /usr/bin/sh
    ln -srv /usr/bin/bash /usr/bin/sh
    ls -l /usr/bin/sh

    # Avoid relying on /bin/sh if at all possible
    %configure_with_bash \
        --without-bash-malloc \
        --with-installed-readline \
        --with-curses \
        --enable-history \
        --enable-nls \
        --enable-readline
build       : |
    %make
install     : |
    %make_install
    %install_file %(pkgdir)/bashrc %(installroot)%(vendordir)/bashrc
    %install_file %(pkgdir)/profile %(installroot)%(vendordir)/profile
    %install_file %(pkgdir)/aeryn-stateless-shell-conf.sh %(installroot)%(vendordir)/aeryn-stateless-shell-conf.sh
    %install_file %(pkgdir)/40-prompt.sh %(installroot)%(vendordir)/profile.d/40-prompt.sh
    %install_file %(pkgdir)/41-alias.sh %(installroot)%(vendordir)/profile.d/41-alias.sh

    # let dash own this for quicker ./configure runs during boulder builds
    # ln -svf bash "%(installroot)%(bindir)/sh"
    # ln -sv bash.1 "%(installroot)%(mandir)/man1/sh.1"

    # These are useless
    rm -rfv %(installroot)%(libdir)/bash/Makefile.*
check       : |
    %make check
workload    : |
    %make check
tuning      :
    # Full seems to cause tests/run-assoc and tests/run-type to hang. This is possibly a Clang 20 bug and should be retested in the future
    - lto : thin
packages    :
    - "%(name)-devel":
        paths:
            - /usr/lib/bash/loadables.h
