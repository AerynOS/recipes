#
# SPDX-FileCopyrightText: Â© 2020-2024 Serpent OS Developers
#
# SPDX-License-Identifier: MPL-2.0
#
name        : krb5
version     : 1.22.2
release     : 5
homepage    : https://web.mit.edu/kerberos/
upstreams   :
    - https://web.mit.edu/kerberos/dist/krb5/1.22/krb5-1.22.2.tar.gz : 3243ffbc8ea4d4ac22ddc7dd2a1dc54c57874c40648b60ff97009763554eaf13
    # - git|https://github.com/krb5/krb5.git : e5b1787d8fbd77208312465107893e5bb98d4651
summary     : network authentication protocol (kerberos)
description : |
    Kerberos is a network authentication protocol. It is designed to provide strong authentication for client/server applications by using secret-key cryptography
license     : MIT
builddeps   :
    - binary(groff)
    - binary(msgfmt)
    - binary(python3)
    - binary(yacc)
    - pkgconfig(cmocka)
    - pkgconfig(com_err)
    - pkgconfig(libkeyutils)
    - pkgconfig(libsasl2)
    - pkgconfig(lmdb)
    - pkgconfig(ldap)
    - pkgconfig(openssl)
    - pkgconfig(readline)
    - pkgconfig(ss)
    # TODO: system verto
environment : |
    cd src
setup       : |
    # Make sure that all scripts are ran with Bash. Dash seems to segfault
    find . \( -type d -name .git -prune \) -o -type f -print0 | xargs -0 sed -i \
        -e 's|#!/bin/sh|#!/usr/bin/bash|g' \
        -e 's|#! /bin/sh|#! /usr/bin/bash|g' \
        -e 's|SHELL=/bin/sh|SHELL=/usr/bin/bash|g'

    %patch %(pkgdir)/ftbfs-glibc-2.43.patch -p2

    %configure_with_bash \
        --disable-rpath \
        --enable-dns-for-realm \
        --with-ldap \
        --with-readline \
        --with-system-et \
        --with-system-ss \
        ac_cv_path_SH="/usr/bin/bash"
build       : |
    %make
install     : |
    %make_install

    # statelessness
    %install_file %(pkgdir)/krb5.tmpfiles %(installroot)/%(libdir)/tmpfiles.d/krb5.conf
    rm -frv %(installroot)/run/ %(installroot)/var/
packages:
    # TODO: Further split into server and client packages
    - "%(name)-libs":
        summary: Non-admin shared libraries used by Kerberos 5
        description: The non-admin shared libraries used by Kerberos 5
        paths:
            - /usr/lib/libgssapi_krb5.so.*
            - /usr/lib/libgssrpc.so.*
            - /usr/lib/libk5crypto.so.*
            - /usr/lib/libkdb5.so.*
            - /usr/lib/libkrad.so.*
            - /usr/lib/libkrb5.so.*
            - /usr/lib/libkrb5support.so.*
            - /usr/lib/libverto.so.* # Remove once libverto is a system package
            - /usr/lib/krb5/plugins/tls/k5tls.so
            - /usr/lib/krb5/plugins/preauth/spake.so
            - /usr/share/locale/
            - /usr/share/man/man5/*k5identity.5*
            - /usr/share/man/man5/*k5login.5*
            - /usr/share/man/man5/krb5.conf.5*
            - /usr/share/man/man7/kerberos.7*

    - "%(name)-devel":
        rundeps:
            - pkgconfig(com_err)
            - pkgconfig(ss)
        paths:
            - /usr/bin/krb5-config
            - /usr/share/man/man1/krb5-config.1*
