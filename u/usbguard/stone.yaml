#
# SPDX-FileCopyrightText: Â© 2020-2025 Serpent OS Developers
#
# SPDX-License-Identifier: MPL-2.0
#
name        : usbguard
version     : 1.1.4
release     : 8
homepage    : https://usbguard.github.io/
upstreams   :
    - https://github.com/USBGuard/usbguard/releases/download/usbguard-1.1.4/usbguard-1.1.4.tar.gz : 7d76b75e779e3c9e6c2fc10e7389dfa34056864c9f0c6eaca722687b7e75893c
summary     : USBGuard - USB device authorization policy framework
description : |
    USBGuard - USB device authorization policy framework
license     : GPL-2.0-or-later
builddeps   :
    - binary(a2x)
    - binary(bison)
    - binary(xsltproc)
    - pkgconfig(bash-completion)
    - pkgconfig(catch2)
    - pkgconfig(dbus-1)
    - pkgconfig(gio-2.0)
    - pkgconfig(libcap-ng)
    - pkgconfig(libqb)
    - pkgconfig(libseccomp)
    - pkgconfig(libssl)
    - pkgconfig(libsystemd)
    - pkgconfig(polkit-gobject-1)
    - pkgconfig(protobuf)
    - docbook
environment : |
    # Temporary, replace with boulder macro
    export XML_CATALOG_FILES="file:///usr/share/defaults/docbook/docbook-dtd/catalog file:///usr/share/defaults/docbook/docbook-xsl/catalog"
setup       : |
    %patch %(pkgdir)/0001-usbguard-daemon-Fix-default-config.patch
    %patch %(pkgdir)/0001-Fix-uutils-install-incompatibility.patch

    %reconfigure \
        --disable-static \
        --with-crypto-library=openssl \
        --with-bundled-pegtl \
        --enable-systemd
build       : |
    %make
install     : |
    %make_install
    %install_dir %(installroot)%(datadir)/factory
    mv %(installroot)/etc %(installroot)%(datadir)/factory/.
    rm -rf %(installroot)/var

    # Install mutable rules via factory
    %tmpfiles "C /etc/usbguard - - - -"
    %tmpfiles "D /etc/usbguard/rules.d 0755 root root -"
    %tmpfiles "D /var/log/usbguard 0755 root root -"
